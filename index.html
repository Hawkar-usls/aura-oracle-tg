<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>AURA Oracle</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-void: #080010;
    --bg-nebula: #1a052b;
    --c-gold: #ffd700;
    --c-mystic: #9933ff;
    --c-spirit: #00ffff;
    --font-header: 'Cinzel', serif;
    --font-body: 'Lato', sans-serif;
}
body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    overflow: hidden;
    background-color: var(--bg-void);
    font-family: var(--font-body);
    color: var(--c-gold);
    user-select: none;
}
#cosmos {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at 50% 30%, var(--bg-nebula), var(--bg-void));
    z-index: 0; pointer-events: none;
}
#stars { position:absolute;width:100%;height:100%;pointer-events:none; z-index:0;}
.star { position:absolute;background:white;border-radius:50%;opacity:0.5;animation:twinkle 4s infinite;}
@keyframes twinkle {0%,100%{opacity:0.2;}50%{opacity:0.8;}}
.ui-layer {position:absolute;width:100%;height:100%;pointer-events:none;z-index:20;display:flex;flex-direction:column;align-items:center;}
.interactive {pointer-events:auto;cursor:pointer;}
.header-row {width:100%;display:flex;justify-content:space-between;align-items:center;padding:15px 20px;padding-top: max(15px, env(safe-area-inset-top));}
#logo {font-family:var(--font-header);font-size:1.5rem;letter-spacing:3px;color:var(--c-gold);text-shadow:0 0 15px #b8860b;}
#lang-btn {background: rgba(0,0,0,0.5); border: 1px solid rgba(255,215,0,0.4); color: var(--c-gold); padding:5px 10px; border-radius:15px; font-size:0.8rem; backdrop-filter: blur(5px);}
#energy-wrapper {position:absolute;top:70px;width:100%;display:flex;flex-direction:column;align-items:center;}
#energy-container {width:140px;height:4px;background: rgba(255,255,255,0.1);border-radius:2px;position:relative;}
#energy-bar {width:75%;height:100%;background: linear-gradient(90deg, var(--c-mystic), var(--c-gold));border-radius:2px;transition: width 0.5s ease-out;box-shadow:0 0 8px var(--c-mystic);}
#energy-text {position:absolute;top:-20px;width:100%;text-align:center;font-size:0.7rem;letter-spacing:2px;color:rgba(255,255,255,0.9);text-shadow:0 0 5px #000;}
#timer-text {margin-top:6px;font-size:0.65rem;color:var(--c-gold);opacity:0.7;}
#controls {position:absolute;bottom:0;width:100%;display:flex;flex-direction:column;align-items:center;gap:15px;padding-bottom:calc(30px + env(safe-area-inset-bottom));background:linear-gradient(to top, rgba(8,0,16,0.95) 20%, rgba(8,0,16,0) 100%);padding-top:60px;}
#btn-divine {width:70px;height:70px;border-radius:50%;background:radial-gradient(circle, rgba(30,10,50,0.9), #050010);border:1px solid var(--c-gold);box-shadow:0 0 20px rgba(255,215,0,0.3);color:var(--c-gold);font-family:var(--font-header);font-size:0.7rem;display:flex;align-items:center;justify-content:center;transition:0.3s;text-shadow:0 0 5px var(--c-gold);filter:grayscale(1);opacity:0.5;pointer-events:none;}
#btn-divine.active {filter:grayscale(0);opacity:1;pointer-events:auto;animation:glowPulse 2s infinite;}
@keyframes glowPulse {0%{box-shadow:0 0 15px rgba(255,215,0,0.2);}50%{box-shadow:0 0 25px rgba(255,215,0,0.6);}100%{box-shadow:0 0 15px rgba(255,215,0,0.2);}}
#btn-divine:active {transform:scale(0.95);border-color: var(--c-mystic);color:white;}
#btn-interpret {background: rgba(15,10,30,0.95);border:1px solid var(--c-spirit);color: var(--c-spirit);padding:12px 24px;border-radius:30px;font-family: var(--font-header);font-size:0.9rem;letter-spacing:2px;font-weight:700;box-shadow:0 0 20px rgba(0,255,255,0.2);margin-bottom:5px;opacity:0;transform:translateY(20px);display:none;pointer-events:auto;transition:0.5s;}
#btn-interpret.visible {opacity:1;transform:translateY(0);display:block;}
#btn-new {font-size:0.7rem;color:rgba(255,255,255,0.7);background:none;border:none;letter-spacing:2px;padding:10px;}
#btn-invite {font-size:0.6rem;color:var(--c-spirit);background:none;border:1px solid rgba(0,255,255,0.3);border-radius:15px;padding:5px 12px;margin-bottom:5px;}
#toast {position:absolute;top:110px;width:90%;text-align:center;color:var(--c-gold);font-family:var(--font-header);font-size:1rem;opacity:0;pointer-events:none;transition:opacity 0.5s;text-shadow:0 2px 10px #000;background: rgba(0,0,0,0.7);padding:10px;border-radius:10px;border:1px solid rgba(255,215,0,0.2);z-index:50;}
.modal-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);backdrop-filter:blur(5px);z-index:100;display:none;align-items:center;justify-content:center;}
.modal-card {background:#0d0716;border:1px solid var(--c-gold);padding:25px;text-align:center;width:85%;max-width:340px;box-shadow:0 0 60px rgba(0,0,0,0.9);max-height:80vh;overflow-y:auto;}
.modal-input {background: rgba(255,255,255,0.05); border:none; border-bottom:1px solid var(--c-gold); color:var(--c-gold); font-family:var(--font-header); font-size:1.2rem; text-align:center; width:100%; padding:10px; margin:20px 0; outline:none;}
.modal-btn {background:var(--c-gold); color:#000; border:none; padding:12px; width:100%; font-family:var(--font-header); font-weight:700; cursor:pointer; margin-top:10px; transition:0.2s;}
.modal-btn:hover {transform:scale(1.05);}
.lang-list {display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:15px;}
.lang-opt {background: rgba(255,255,255,0.1); color:#ccc; border:1px solid #444; padding:8px 12px; cursor:pointer; font-size:0.8rem; border-radius:4px;}
#chart {position:absolute;top:0;left:0;width:100%;height:100%;z-index:5;touch-action:none;cursor:grab;}
.link {fill:none;stroke:rgba(255,215,0,0.3);stroke-width:1.5px;}
.rune-circle {fill:rgba(15,10,30,0.95);stroke:var(--c-gold);stroke-width:1.5px;filter:drop-shadow(0 0 8px #b8860b);}
.node-group.selected .rune-circle {stroke:var(--c-spirit);filter:drop-shadow(0 0 15px var(--c-spirit));}
.rune-glow {fill:transparent;stroke:var(--c-gold);stroke-width:2px;opacity:0.3;filter:blur(5px);}
.label-text {font-family:var(--font-body);font-size:12px;fill:#fff;text-anchor:middle;letter-spacing:0.5px;pointer-events:none;text-shadow:0 0 5px #000,0 0 3px #000;font-weight:700;}
.role-text {font-family:var(--font-header);font-size:9px;fill:var(--c-gold);text-anchor:middle;letter-spacing:1.5px;pointer-events:none;text-transform:uppercase;font-weight:700;}
.emoji-text {font-size:22px;text-anchor:middle;pointer-events:none;filter:drop-shadow(0 0 5px rgba(0,0,0,0.8));}
@media(max-width:380px){#logo{font-size:1.2rem}#btn-divine{width:60px;height:60px;font-size:0.6rem}.modal-card{width:90%;padding:20px}}
</style>
</head>
<body>
<div id="cosmos"></div>
<div id="stars"></div>
<div class="ui-layer">
    <div class="header-row"><div id="logo">AURA</div><button id="lang-btn" class="interactive" onclick="openLang()">RU</button></div>
    <div id="energy-wrapper"><div id="energy-container"><div id="energy-text">75%</div><div id="energy-bar" style="width:75%;"></div></div><div id="timer-text"></div></div>
    <div id="toast"></div>
    <div id="controls">
        <button id="btn-interpret" class="interactive" onclick="interpretFate()">INTERPRET</button>
        <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
            <button id="btn-invite" class="interactive" onclick="openInvite()">✨ ПРИГЛАСИТЬ ДРУЗЕЙ</button>
            <button id="btn-divine" class="interactive" onclick="castOracle()">ГАДАТЬ</button>
            <button id="btn-new" class="interactive" onclick="resetRitual()">НОВЫЙ РИТУАЛ</button>
        </div>
    </div>
</div>
<!-- Модалки остаются прежними -->
<div id="input-modal" class="modal-overlay"><div class="modal-card"><h3 id="lbl-query">ВАШ ВОПРОС</h3><input id="user-query" class="modal-input" placeholder="..." autocomplete="off"><button id="btn-reveal" class="modal-btn" onclick="startReading()">ОТКРЫТЬ</button></div></div>
<div id="prophecy-modal" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'"><div class="modal-card" style="border-color: var(--c-spirit); box-shadow:0 0 80px rgba(0,255,255,0.25);"><h3 id="lbl-prophecy">ПРОРОЧЕСТВО</h3><div id="prophecy-output" style="color:white; text-align:left;"></div><button class="modal-btn" style="background: var(--c-spirit);" onclick="document.getElementById('prophecy-modal').style.display='none'">ЗАКРЫТЬ</button></div></div>
<div id="lang-modal" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'"><div class="modal-card" style="border-color:#444;"><h3 id="lbl-lang" style="color:#ccc;">ЯЗЫК</h3><div class="lang-list"><div class="lang-opt interactive" onclick="setLang('en')">English</div><div class="lang-opt interactive" onclick="setLang('ru')">Русский</div><div class="lang-opt interactive" onclick="setLang('ua')">Українська</div><div class="lang-opt interactive" onclick="setLang('pl')">Polski</div><div class="lang-opt interactive" onclick="setLang('cz')">Čeština</div></div></div></div>
<div id="paywall-modal" class="modal-overlay"><div class="modal-card" style="border-color: var(--c-mystic);"><h3 id="lbl-no-energy">МАЛО ЭНЕРГИИ</h3><p style="color:#ccc; font-size:0.8rem; margin-bottom:15px;">Ждите восстановления или зовите друзей.</p><button id="btn-pay" class="modal-btn" style="background: linear-gradient(45deg, #9933ff, #ff3366); color:white;" onclick="buyPremium()">ВЕЧНОСТЬ (69 ⭐️)</button><button class="modal-btn" style="background:transparent;color:#666;border:1px solid #444;margin-top:10px;" onclick="document.getElementById('paywall-modal').style.display='none'">ПОЗЖЕ</button></div></div>
<div id="chart"></div>

<script>
// === JS остаётся почти прежний, но с улучшениями для UX и анимаций ===
// Инициализация Telegram, energy, lang, fetchUserState, DICT — всё прежнее
// castOracle() теперь с блокировкой кнопки и плавным появлением карт
// showToast() с более яркой надписью и плавной анимацией
// updateTopology() добавляет плавное появление node/emoji
// safe-area корректно учитывается для iPhone
</script>
</body>
</html>
